<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet'emote: Pet Emotion Analyzer</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            max-width: 600px;
            width: 100%;
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 32px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
        .file-input-label {
            display: block;
            padding: 12px 24px;
            background-color: #60a5fa; /* Blue-500 */
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-weight: 600;
        }
        .file-input-label:hover {
            background-color: #3b82f6; /* Blue-600 */
        }
        #imagePreview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
            object-fit: contain;
            margin: 0 auto;
            display: none; /* Hidden by default */
            border: 1px solid #e2e8f0; /* Gray-200 */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
            display: none; /* Hidden by default */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px; /* Space between logo and text */
        }
        .logo-img { /* New style for the JPEG image */
            width: 85px; /* Adjust size as needed */
            height: 85px; /* Adjust size as needed */
            border-radius: 8px; /* Optional: adds rounded corners to the image */
            object-fit: cover; /* Ensures the image covers the area without distortion */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <!-- Replaced SVG with an <img> tag for JPEG logo -->
            <img class="logo-img" src="logo.jpg" alt="Pet'emote Logo">
            <h1 class="text-3xl font-bold text-gray-800">Pet'emote</h1>
        </div>
        <p class="text-gray-600">Upload an image of your dog or cat to understand their emotions!</p>

        <!-- Image Upload Section -->
        <div class="file-input-wrapper">
            <input type="file" id="imageUpload" accept="image/*" class="file-input">
            <label for="imageUpload" class="file-input-label">
                Select Pet Image
            </label>
        </div>

        <!-- Image Preview -->
        <img id="imagePreview" src="#" alt="Image Preview">

        <!-- Analyze Button -->
        <button id="analyzeButton" class="bg-emerald-500 text-white py-3 px-6 rounded-lg font-bold shadow-md hover:bg-emerald-600 transition-colors duration-300 transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-opacity-50">
            Analyze Emotion
        </button>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading-spinner"></div>

        <!-- Result Display -->
        <div id="resultDisplay" class="bg-blue-50 p-6 rounded-lg text-left shadow-inner border border-blue-200">
            <h2 class="text-xl font-semibold text-blue-800 mb-2">Emotion Analysis:</h2>
            <p id="emotionText" class="text-gray-700 italic">Upload an image and click 'Analyze Emotion' to see results.</p>
        </div>
    </div>

    <!-- Custom Modal for Messages -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p id="modalMessage" class="text-lg text-gray-800"></p>
            <button id="modalOkButton" class="mt-4 bg-blue-500 text-white py-2 px-5 rounded-md hover:bg-blue-600 transition-colors duration-300">OK</button>
        </div>
    </div>

    <script>
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const analyzeButton = document.getElementById('analyzeButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const emotionText = document.getElementById('emotionText');
        const myModal = document.getElementById('myModal');
        const modalMessage = document.getElementById('modalMessage');
        const closeButton = document.querySelector('.close-button');
        const modalOkButton = document.getElementById('modalOkButton');

        let uploadedBase64Image = null; // Store the base64 image
        let uploadedImageMimeType = null; // Store the image MIME type

        // Function to show the custom modal
        function showModal(message) {
            modalMessage.textContent = message;
            myModal.style.display = 'flex'; // Use flex to center
        }

        // Function to hide the custom modal
        function hideModal() {
            myModal.style.display = 'none';
        }

        // Close button and OK button handlers for the modal
        closeButton.onclick = hideModal;
        modalOkButton.onclick = hideModal;
        window.onclick = function(event) {
            if (event.target == myModal) {
                hideModal();
            }
        };

        // Handle image file selection
        imageUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                // Check if the file is an image
                if (!file.type.startsWith('image/')) {
                    showModal('Please upload a valid image file (e.g., JPEG, PNG).');
                    imageUpload.value = ''; // Clear the file input
                    imagePreview.style.display = 'none';
                    uploadedBase64Image = null;
                    uploadedImageMimeType = null;
                    emotionText.textContent = 'Upload an image and click \'Analyze Emotion\' to see results.';
                    return;
                }

                uploadedImageMimeType = file.type;
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block'; // Show the image
                    uploadedBase64Image = e.target.result.split(',')[1]; // Get base64 part
                    emotionText.textContent = 'Image selected. Click "Analyze Emotion" to see results.';
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.src = '#';
                imagePreview.style.display = 'none';
                uploadedBase64Image = null;
                uploadedImageMimeType = null;
                emotionText.textContent = 'Upload an image and click \'Analyze Emotion\' to see results.';
            }
        });

        // Handle analyze button click
        analyzeButton.addEventListener('click', async function() {
            if (!uploadedBase64Image || !uploadedImageMimeType) {
                showModal('Please select an image first.');
                return;
            }

            loadingSpinner.style.display = 'block'; // Show loading spinner
            emotionText.textContent = 'Analyzing emotion... Please wait.';
            analyzeButton.disabled = true; // Disable button during analysis

            try {
                // Prompt for the Gemini Vision model
                const prompt = "Analyze the emotion and current situation of the dog or cat in this image. Is it hungry, playful, sleepy, sad, happy, curious, or showing any other distinct emotion? Describe its current situation in a concise manner. Focus on what the pet might be feeling or doing.";

                // Gemini API call configuration
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: prompt },
                                {
                                    inlineData: {
                                        mimeType: uploadedImageMimeType,
                                        data: uploadedBase64Image
                                    }
                                }
                            ]
                        }
                    ],
                };

                console.log('API Request Payload:', JSON.stringify(payload, null, 2)); // Log the payload

                // Your provided API key
                const apiKey = "AIzaSyCcPlWydAmf4IQEQwLqvk_ZrJbxWQE1cYY"; // Make sure to replace this with your actual key if needed
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                console.log('API URL being used:', apiUrl); // Log the full API URL including the key parameter

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log('API Response Status:', response.status); // Log the response status
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response Text:', errorText);
                    // Provide a more direct error message to the user about the 403
                    if (response.status === 403) {
                         showModal(`API Error: 403 Forbidden. This usually means the API key is missing or invalid. Please ensure your environment is correctly providing the API key.`);
                         emotionText.textContent = 'Analysis failed: API Key Error (403 Forbidden).';
                    } else {
                         showModal(`API Error: ${response.status} - ${errorText.substring(0, Math.min(errorText.length, 150))}... Check console for full error.`);
                         emotionText.textContent = 'Analysis failed due to API error.';
                    }
                    return;
                }

                const result = await response.json();
                console.log('API Result (Parsed JSON):', result); // Log the parsed JSON result

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    emotionText.textContent = text;
                } else {
                    emotionText.textContent = 'Could not get a valid response from the AI. The response structure was unexpected or empty.';
                    console.error('Unexpected API response structure or empty content:', result);
                    showModal('Could not get a valid response from the AI. The response structure was unexpected. See console for details.');
                }

            } catch (error) {
                console.error('Error analyzing image (network or parsing):', error);
                showModal('A network error or parsing error occurred while analyzing the image. Please check your internet connection or console for more details.');
                emotionText.textContent = 'Analysis failed. Please try again.';
            } finally {
                loadingSpinner.style.display = 'none'; // Hide loading spinner
                analyzeButton.disabled = false; // Re-enable button
            }
        });
    </script>
</body>
</html>
